<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagicPoint</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #app {
            flex: 1;
        }
        footer {
            text-align: center;
            padding: 10px;
            background-color: #f1f1f1;
        }
        .sign-in-button {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .hidden {
            display: none;
        }
        .verification-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .verification-container button,
        .verification-container input {
            margin-bottom: 10px;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe.js library -->
    <meta name="google-signin-client_id" content="370153813454-lkjg1u7gurqj3vfp3adqbsoe9p2ss9ht.apps.googleusercontent.com">
</head>
<body>
    <div id="app">
        <h1>Talk</h1>
        <div class="options">
            <button class="purchase-button" data-minutes="1">1 Minutes - $1</button>
            <button class="purchase-button" data-minutes="100">5 Minutes - $5</button>
            <button class="purchase-button" data-minutes="90">20 Minutes - $20</button>
            <button class="purchase-button" data-minutes="90">110 Minutes - $100</button>
        </div>
        <button id="username" style="display:none;" onclick="showUsername()"></button>
        <div class="g-signin2 sign-in-button" data-onsuccess="onSignIn"></div>
        <button id="user-signed-in" class="hidden" onclick="showUsername()">User Signed In</button>
    </div>
    <footer>
        <p>&copy; 2024 MAGICPOINT, INC. Version 1.0.9. Last updated: October 26, 2024 8:17 P.M.</p>
    </footer>
    <script>
        async function initializeFirebase() {
            const response = await fetch('/getFirebaseConfig');
            const firebaseConfig = await response.json();
            firebase.initializeApp(firebaseConfig);
        }

        initializeFirebase();

        function onSignIn(googleUser) {
            const profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId());
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail());

            // Show the user-signed-in button
            document.getElementById('user-signed-in').classList.remove('hidden');
        }

        // Stripe initialization
        const stripe = Stripe('pk_test_51QEMwJQuGWNDNoDwtiLLlXCTDKvHD3cjfAZ8aZO13kky0hWo5nteaOam9Va0ccXl2trfC0i6wqxtPsUj44bAMEls00md6kF4Fc');

        document.querySelectorAll('.purchase-button').forEach(button => {
            button.addEventListener('click', async (event) => {
                const minutes = event.target.getAttribute('data-minutes');
                try {
                    const response = await fetch('https://talk-89b49.cloudfunctions.net/createCheckoutSession', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ minutes })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const session = await response.json();
                    const result = await stripe.redirectToCheckout({ sessionId: session.id });

                    if (result.error) {
                        console.error(result.error.message);
                        alert(result.error.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('There was an error processing your request. Please try again.');
                }
            });
        });
    </script>
</body>
</html>